<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íƒœì›ì›ìƒì˜ ëŒ€ë ¨ ì—¬í–‰ê¸°</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        .header h1 {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }
        .header p { font-size: 1.1em; opacity: 0.95; }
        .header-info {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 0.9em;
            opacity: 0.9;
            text-align: right;
        }
        .header-weather {
            position: absolute;
            top: 20px;
            left: 30px;
        }
        .weather-info {
            display: inline-flex;
            align-items: center;
            justify-content: space-around;
            flex-direction: row;
            gap: 12px;
            width: 240px;
            height: 120px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            backdrop-filter: blur(10px);
            font-size: 1em;
            vertical-align: middle;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        .weather-icon { font-size: 5em; line-height: 1; }
        .weather-text { display: flex; flex-direction: column; align-items: flex-start; gap: 4px; }
        .weather-temp { font-weight: 700; font-size: 1.6em; }
        .weather-desc { font-size: 1.05em; opacity: 0.95; text-align: left; }
        .weather-loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        .weather-alert {
            margin-top: 6px;
            font-size: 0.9em;
            color: #fff;
            background: rgba(0, 0, 0, 0.25);
            padding: 6px 10px;
            border-radius: 12px;
            display: inline-block;
        }
        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 0;
            height: calc(100vh - 200px);
            min-height: 700px;
        }
        .sidebar {
            background: #f8f9fa;
            padding: 25px;
            overflow-y: auto;
            border-right: 1px solid #e0e0e0;
        }
        .control-panel { margin-bottom: 30px; }
        .control-panel h2 {
            font-size: 1.3em;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .day-selector {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #667eea;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 500;
            background: white;
            color: #333;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        .day-selector:hover { border-color: #764ba2; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }
        .day-selector:focus { outline: none; border-color: #764ba2; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2); }
        .legend {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }
        .legend h3 { font-size: 1.1em; margin-bottom: 15px; color: #333; }
        .legend-item { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; padding: 8px; border-radius: 6px; transition: background 0.2s; }
        .legend-item:hover { background: #f0f0f0; }
        .legend-icon { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 4px; font-size: 14px; }
        .legend-clickable { cursor: pointer; user-select: none; }
        .info-panel { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }
        .info-panel h3 { font-size: 1.1em; margin-bottom: 15px; color: #333; }
        .day-info { display: none; animation: fadeIn 0.3s ease; }
        .day-info.active { display: block; }
        .day-info h4 { color: #667eea; margin-bottom: 10px; font-size: 1.2em; }
        .stop-item { padding: 10px; margin-bottom: 8px; background: #f8f9fa; border-left: 4px solid #667eea; border-radius: 4px; cursor: pointer; transition: all 0.2s; }
        .stop-item:hover { background: #e9ecef; transform: translateX(5px); }
        .stop-item.food { border-left-color: #ff8c00; }
        .stop-item.accommodation { border-left-color: #FFC300; }
        .stop-item.choice { border-left-color: #e83e8c; background: #fff0f6; border-left-style: dashed; }
        .map-container { position: relative; background: #e0e0e0; }
        #map { width: 100%; height: 100%; }
        .custom-div-icon { background-color: transparent; border: none; text-align: center; }
        .marker-label {
            color: white; padding: 6px 10px; border-radius: 8px; font-weight: 600; font-size: 13px;
            white-space: nowrap; border: 2px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            position: absolute; transform: translate(-50%, -100%); margin-top: -5px; font-family: 'Noto Sans KR', sans-serif;
        }
        .food-marker-label {
            background: linear-gradient(135deg, #ff8c00, #ff6b00); color: white; padding: 6px 10px; border-radius: 8px;
            font-weight: 600; font-size: 13px; white-space: nowrap; border: 2px solid white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); position: absolute; transform: translate(-50%, -100%);
            margin-top: -5px; font-family: 'Noto Sans KR', sans-serif;
        }
        .choice-marker-label {
            background: linear-gradient(135deg, #e83e8c, #d63384); color: white; padding: 6px 10px; border-radius: 20px;
            font-weight: 600; font-size: 13px; white-space: nowrap; border: 2px solid white; border-style: dashed;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); position: absolute; transform: translate(-50%, -100%);
            margin-top: -5px; font-family: 'Noto Sans KR', sans-serif;
        }
        .accommodation-icon { background-color: transparent; border: none; text-align: center; font-size: 32px; line-height: 1; color: #FFC300; text-shadow: 0 0 10px rgba(0, 0, 0, 0.8), 0 0 20px rgba(255, 195, 0, 0.5); filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3)); }
        .airport-icon { background-color: transparent; border: none; text-align: center; font-size: 28px; line-height: 1; color: #007bff; text-shadow: 0 0 10px rgba(0, 0, 0, 0.8); filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3)); }
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .stat-item { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 12px; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 1.5em; font-weight: 700; }
        .stat-label { font-size: 0.9em; opacity: 0.9; }
        .loading { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; background: white; padding: 20px 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2); }
        .loading.active { display: block; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px);} to { opacity: 1; transform: translateY(0);} }
        @media (max-width: 1024px) {
            .main-content { grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
            .sidebar { max-height: 320px; border-right: none; border-bottom: 1px solid #e0e0e0; }
            .header h1 { font-size: 2em; }
            .header-info { position: static; margin-top: 10px; text-align: center; }
            .header-weather { position: static; margin: 10px 0; text-align: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-weather">
                <span id="weatherInfo" class="weather-info"><span class="weather-loading"></span></span>
                <div id="weatherAlert" class="weather-alert" style="display:none;"></div>
            </div>
            <div class="header-info">
                ì‘ì„±ì: ì •ì›ì² <br>
                ì‘ì„±ì¼: 2025ë…„ 12ì›” 9ì¼
            </div>
            <h1><i class="fas fa-map-marked-alt"></i> íƒœì›ì›ìƒì˜ ëŒ€ë ¨ ì—¬í–‰ê¸°</h1>
            <p>2025.01.23(ê¸ˆ) ~ 01.26(ì›”)</p>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="control-panel">
                    <h2><i class="fas fa-calendar-alt"></i> ë™ì„  ì„ íƒ</h2>
                    <select id="daySelector" class="day-selector">
                        <option value="all">ğŸ“… ì „ì²´ ë³´ê¸° (Day 1-4)</option>
                        <option value="1">Day 1 - ì‹œë‚´ & ëŒ€í•™ê°€</option>
                        <option value="2">Day 2 - ì‡¼í•‘ & ë¨¹ë°©</option>
                        <option value="3">Day 3 - ì—­ì‚¬ & ì‹œì¥</option>
                        <option value="4">Day 4 - ì¶œë°œ</option>
                    </select>
                </div>

                <div class="info-panel">
                    <h3><i class="fas fa-list"></i> ìƒì„¸ ì •ë³´</h3>
                    <div id="dayInfo" class="day-info active">
                        <h4>ì „ì²´ ì—¬í–‰ ì¼ì •</h4>
                        <p style="color: #666; margin-bottom: 15px;">4ì¼ê°„ì˜ ëŒ€ë ¨ ì—¬í–‰ ì½”ìŠ¤ë¥¼ í™•ì¸í•˜ì„¸ìš”. â“ ì•„ì´ì½˜ì€ ì„ íƒ ê°€ëŠ¥í•œ í›„ë³´ì§€ì…ë‹ˆë‹¤.</p>
                        <div class="stats">
                            <div class="stat-item">
                                <div class="stat-value">4</div>
                                <div class="stat-label">ì—¬í–‰ ì¼ìˆ˜</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="totalStops">0</div>
                                <div class="stat-label">ì´ ë°©ë¬¸ì§€</div>
                            </div>
                        </div>
                    </div>

                    <div id="day1Info" class="day-info">
                        <h4>Day 1 - ì‹œë‚´ & ëŒ€í•™ê°€</h4>
                        <div class="stop-item accommodation" onclick="focusMarker(1, 1)">
                            <strong>1. ìˆ™ì†Œ ì§ë³´ê´€ (10:00)</strong><br>
                            <small>ì¤‘ì‚°ê´‘ì¥ ì¸ê·¼ ìˆ™ì†Œ</small>
                        </div>
                        <div class="stop-item food" onclick="focusMarker(1, 2)">
                            <strong>2. ì”¬ì”½í™˜ì²­ì¹´ì˜¤ì•¼ì— ğŸ´ (10:30)</strong><br>
                            <small>ë² ì´ì§•ë•(ì˜ˆì•½í•„ìˆ˜), ì˜¤ë¦¬ê»ë°ê¸°+ì„¤íƒ•, ëª¨ë‹ê¸€ë¡œë¦¬, ì˜¤ë¦¬ë¼ˆíŠ€ê¹€</small>
                        </div>
                        <div class="stop-item" onclick="focusMarker(1, 3)">
                            <strong>3. ìš°í˜¸ê´‘ì¥ (12:00)</strong><br>
                            <small>êµ¬ì²´ íˆ¬ì–´</small>
                        </div>
                        <div class="stop-item" onclick="focusMarker(1, 4)">
                            <strong>4. ëŒ€ë ¨ì—­ íŠ¸ë¨íƒ€ê¸° (12:30)</strong><br>
                            <small>201ë²ˆ ì˜¬ë“œ íŠ¸ë¨ (ì¸ë‹¹ 1.5ìœ„ì•ˆ)</small>
                        </div>
                        <div class="stop-item food" onclick="focusMarker(1, 5)">
                            <strong>5. ë¯¸ì‰ë¹™ì²­ ğŸ´ (13:00)</strong><br>
                            <small>ë²„ë¸”í‹° (6ìœ„ì•ˆ)</small>
                        </div>
                         <div class="stop-item" onclick="focusMarker(1, 6)">
                            <strong>6. ë™ë°©ìˆ˜ì„± (13:30)</strong><br>
                            <small>ê²¨ìš¸ì²  ìš´ì˜ì•ˆí•¨, ìì „ê±° 10ë¶„ 8ìœ„ì•ˆ</small>
                        </div>
                         <div class="stop-item food" onclick="focusMarker(1, 7)">
                            <strong>7. ìº‰ì œì–‘ê¼¬ì¹˜ ğŸ´ (16:00)</strong><br>
                            <small>ì§€ì‚¼ì„ , ë§Œí† ìš°ê¼¬ì¹˜, ê°€ì§€êµ¬ì´, ë”°ìš”ë¹„ì•¤</small>
                        </div>
                        <div class="stop-item food" onclick="focusMarker(1, 8)">
                            <strong>8. êµí†µëŒ€ ì•¼ì‹œì¥ ğŸ´ (18:00)</strong><br>
                            <small>í­ì¦™ë”°ìš”ë¹„ì•¤(ê³ ê¸°), ì¥êµ°ê¶ˆì¿ ì´(ë§¤ìš´ë§›), ë³¶ìŒë°¥</small>
                        </div>
                    </div>

                    <div id="day2Info" class="day-info">
                        <h4>Day 2 - ì‡¼í•‘ & ë¨¹ë°©</h4>
                        <div class="stop-item food" onclick="focusMarker(2, 1)">
                            <strong>1. ì‹œìŸˆë” ì°ë§Œë‘ ğŸ´ (11:00)</strong><br>
                            <small>ë‚ ì¹˜ì•Œìƒˆìš°ë§Œë‘ (ì¶”+ë¼ì¡°ì¥+ë§ˆëŠ˜ ì†ŒìŠ¤)</small>
                        </div>
                        <div class="stop-item food" onclick="focusMarker(2, 2)">
                            <strong>2. ë£¨ì´ì”½ì»¤í”¼ ğŸ´ (12:00)</strong><br>
                            <small>ì‹í›„ ì»¤í”¼</small>
                        </div>
                        <div class="stop-item" onclick="focusMarker(2, 3)">
                            <strong>3. íŒŒë¹Œë¦¬ì˜¨ / ë‰´ë§ˆíŠ¸ (12:30)</strong><br>
                            <small>ì‡¼í•‘ëª° êµ¬ê²½</small>
                        </div>
                        <div class="stop-item" onclick="focusMarker(2, 4)">
                            <strong>4. ë™ê´€ì§€ì— (15:00)</strong><br>
                            <small>ì—­ì‚¬ ë¬¸í™” ê±°ë¦¬</small>
                        </div>
                         <div class="stop-item" onclick="focusMarker(2, 5)">
                            <strong>5. ë¡œì“°í‘¸ê´‘ì¥ (15:30)</strong><br>
                            <small>ì‡¼í•‘ ë° êµ¬ê²½</small>
                        </div>
                         <div class="stop-item" onclick="focusMarker(2, 6)">
                            <strong>6. ì„œì•ˆë¡œì•¼ì‹œì¥ (16:00)</strong><br>
                            <small>ì‹¤ë‚´ì•¼ì‹œì¥ / ë³´ë³´ì§€, ì§€ìŸˆ, êµ´êµ¬ì´</small>
                        </div>
                         <div class="stop-item choice" onclick="focusMarker(2, 7)">
                            <strong>7-1. [í›„ë³´] í•˜ì´ë””ë¼ì˜¤ â“</strong><br>
                            <small>í› ê¶ˆ (ë¡œì“°í‘¸ ì¸ê·¼)</small>
                        </div>
                        <div class="stop-item choice" onclick="focusMarker(2, 8)">
                            <strong>7-2. [í›„ë³´] ë°í› ì¹´ì˜¤ì°¬ â“</strong><br>
                            <small>êµ¬ì´ ìš”ë¦¬</small>
                        </div>
                        <div class="stop-item choice" onclick="focusMarker(2, 9)">
                            <strong>7-3. [í›„ë³´] ì²œì¼í•˜ â“</strong><br>
                            <small>ì¼ì‹/í•´ì‚°ë¬¼</small>
                        </div>
                    </div>

                    <div id="day3Info" class="day-info">
                        <h4>Day 3 - ì—­ì‚¬ & ì‹œì¥</h4>
                        <div class="stop-item choice" onclick="focusMarker(3, 1)">
                            <strong>1-1. [ì•„ì¹¨í›„ë³´] ì†Œì„±ì£½ë„ â“</strong><br>
                            <small>ì„±ê²Œë”¤ì„¬, ì£½</small>
                        </div>
                         <div class="stop-item choice" onclick="focusMarker(3, 2)">
                            <strong>1-2. [ì•„ì¹¨í›„ë³´] ë£¨ì™•ìì´ â“</strong><br>
                            <small>ë”¤ì„¬, íŒŒê¸°ë¦„ë³¶ìŒë©´</small>
                        </div>
                        <div class="stop-item" onclick="focusMarker(3, 3)">
                            <strong>2. ëŸ¬ì‹œì•„ê±°ë¦¬ (12:00)</strong><br>
                            <small>ì´êµ­ì ì¸ í’ê²½</small>
                        </div>
                        <div class="stop-item choice" onclick="focusMarker(3, 4)">
                            <strong>3-1. [ììœ í›„ë³´] ì¹˜ì¹˜ì§€ì— â“</strong><br>
                            <small>ì¹´í˜ ê±°ë¦¬</small>
                        </div>
                        <div class="stop-item choice" onclick="focusMarker(3, 5)">
                            <strong>3-2. [ììœ í›„ë³´] ì„±í•´ê´‘ì¥ â“</strong><br>
                            <small>ëŒ€ë ¨ ëœë“œë§ˆí¬</small>
                        </div>
                        <div class="stop-item choice" onclick="focusMarker(3, 6)">
                            <strong>3-3. [ììœ í›„ë³´] ë§ˆì‚¬ì§€ìƒµ â“</strong><br>
                            <small>íœ´ì‹</small>
                        </div>
                         <div class="stop-item choice" onclick="focusMarker(3, 7)">
                            <strong>3-4. [ììœ í›„ë³´] ì–´ì¸ë¶€ë‘ â“</strong><br>
                            <small>í•­êµ¬ í’ê²½</small>
                        </div>
                        <div class="stop-item" onclick="focusMarker(3, 8)">
                            <strong>4. í‘¸í›„ì´ ì‹ ì„ ì‹í’ˆ (16:00)</strong><br>
                            <small>ë§ˆíŠ¸ êµ¬ê²½</small>
                        </div>
                        <div class="stop-item" onclick="focusMarker(3, 9)">
                            <strong>5. ë¼ì˜¤ì§€ì—ì•¼ì‹œì¥ (17:00)</strong><br>
                            <small>ì•¼ì‹œì¥ íˆ¬ì–´</small>
                        </div>
                        <div class="stop-item food" onclick="focusMarker(3, 10)">
                            <strong>6. ë°ì§€ì¹´ì˜¤ìœ„ ğŸ´ (19:00)</strong><br>
                            <small>ìƒì„ ì°œ(ë†ì–´+ë§ˆëŠ˜ë§›), ìŒ€ë°¥ í•„ìˆ˜</small>
                        </div>
                         <div class="stop-item accommodation" onclick="focusMarker(3, 11)">
                            <strong>7. ìˆ™ì†Œ ë„ì°© (22:00)</strong><br>
                            <small>ì¼ì • ë§ˆë¬´ë¦¬</small>
                        </div>
                    </div>

                    <div id="day4Info" class="day-info">
                        <h4>Day 4 - ì¶œë°œ</h4>
                        <div class="stop-item" onclick="focusMarker(4, 1)">
                            <strong>1. ì¤‘ì‚°ê´‘ì¥ ì¶œë°œ</strong>
                        </div>
                        <div class="stop-item" onclick="focusMarker(4, 2)">
                            <strong>2. ì£¼ìˆ˜ì´ì¦ˆ êµ­ì œê³µí•­ (DLC)</strong><br>
                            <small>ì¶œë°œ</small>
                        </div>
                    </div>
                </div>

                <div class="legend">
                    <h3><i class="fas fa-info-circle"></i> ë²”ë¡€</h3>
                    <div class="legend-item">
                        <div class="legend-icon" style="background: #FFC300; color: white;"><i class="fas fa-star"></i></div>
                        <span>ìˆ™ì†Œ (ì¤‘ì‚°ê´‘ì¥)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-icon" style="background: #e83e8c; color: white; border-style: dashed;"><i class="fas fa-question"></i></div>
                        <span>ì„ íƒì§€ (í›„ë³´ì¥ì†Œ)</span>
                    </div>
                    <div class="legend-item legend-clickable" id="legendFood">
                        <div class="legend-icon" style="background: #ff8c00; color: white;"><i class="fas fa-utensils"></i></div>
                        <span>ìŒì‹ì </span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-icon" style="background: #007bff; color: white;"><i class="fas fa-map-marker-alt"></i></div>
                        <span>Day 1 ê²½ë¡œ</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-icon" style="background: #dc3545; color: white;"><i class="fas fa-map-marker-alt"></i></div>
                        <span>Day 2 ê²½ë¡œ</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-icon" style="background: #28a745; color: white;"><i class="fas fa-map-marker-alt"></i></div>
                        <span>Day 3 ê²½ë¡œ</span>
                    </div>
                </div>
            </div>

            <div class="map-container">
                <div id="map"></div>
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <div>ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // OpenWeatherMap API í‚¤ (ì‚¬ìš©ì ì œê³µ í‚¤)
        const WEATHER_API_KEY = '9a9542cafe537472257fc12fa6f9d2d5';
        const DALIAN_LAT = 38.915;
        const DALIAN_LNG = 121.615;

        async function fetchWeather() {
            try {
                const url = `https://api.openweathermap.org/data/2.5/weather?lat=${DALIAN_LAT}&lon=${DALIAN_LNG}&appid=${WEATHER_API_KEY}&units=metric&lang=kr`;
                const response = await fetch(url);
                if (!response.ok) throw new Error('ë‚ ì”¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                const data = await response.json();
                displayWeather(data);
            } catch (error) {
                console.error('ë‚ ì”¨ ì •ë³´ ì˜¤ë¥˜:', error);
                document.getElementById('weatherInfo').innerHTML = '<span style="font-size: 0.8em; opacity: 0.8;">ë‚ ì”¨ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</span>';
            }
        }

        function displayWeather(data) {
            const temp = Math.round(data.main.temp);
            const description = data.weather[0].description;
            const main = data.weather[0].main.toLowerCase();
            const icon = data.weather[0].icon;
            const iconSymbolMap = {
                thunderstorm: 'â›ˆï¸',
                drizzle: 'ğŸŒ¦ï¸',
                rain: 'ğŸŒ§ï¸',
                snow: 'ğŸŒ¨ï¸',
                clear: 'â˜€ï¸',
                clouds: 'â˜ï¸',
                mist: 'ğŸŒ«ï¸',
                haze: 'ğŸŒ«ï¸',
                fog: 'ğŸŒ«ï¸'
            };
            const iconSymbol = iconSymbolMap[main] || 'ğŸŒ¤ï¸';
            const weatherHTML = `
                <span class="weather-icon">${iconSymbol}</span>
                <div class="weather-text">
                    <span class="weather-temp">${temp}Â°C</span>
                    <span class="weather-desc">${description}</span>
                </div>
            `;
            document.getElementById('weatherInfo').innerHTML = weatherHTML;

            const alertBox = document.getElementById('weatherAlert');
            const isRain = ['rain', 'drizzle', 'thunderstorm'].includes(main) || description.includes('ë¹„');
            const isSnow = ['snow'].includes(main) || description.includes('ëˆˆ');
            if (isRain) {
                alertBox.textContent = 'ë¹„ ì˜ˆë³´: ìš°ì‚°ì„ ì¤€ë¹„í•˜ì„¸ìš”!';
                alertBox.style.display = 'inline-block';
            } else if (isSnow) {
                alertBox.textContent = 'ëˆˆ ì˜ˆë³´: ë”°ëœ»í•œ ë³µì¥ê³¼ ë¯¸ë„ëŸ¼ ì£¼ì˜!';
                alertBox.style.display = 'inline-block';
            } else {
                alertBox.style.display = 'none';
            }
        }

        // ì§€ë„ ì´ˆê¸°í™”
        var map = L.map('map', { zoomControl: true, scrollWheelZoom: true }).setView([38.915, 121.615], 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // ì—¬í–‰ ì¼ì • ë°ì´í„° (Day 1ê³¼ 2 êµì²´ë¨, ì„ íƒì§€ ì¶”ê°€)
        var itinerary = [
            // Day 1 (ê¸°ì¡´ Day 2) - ì‹œë‚´ & ëŒ€í•™ê°€
            { day: 1, stop: 1, name: "ìˆ™ì†Œ ì§ë³´ê´€ (10:00)", label: "ì§ë³´ê´€", lat: 38.9216, lng: 121.6427, color: '#007bff', isAccommodation: true, description: "ì¤‘ì‚°ê´‘ì¥ ì¸ê·¼ ìˆ™ì†Œ" },
            { day: 1, stop: 2, name: "ì”¬ì”½í™˜ì²­ì¹´ì˜¤ì•¼ì— (10:30)", label: "ë² ì´ì§•ë•", lat: 38.9220, lng: 121.6380, color: '#007bff', isFood: true, description: "ë² ì´ì§•ë•ì „ë¬¸ì (ì˜ˆì•½í•„ìˆ˜) / ì˜¤ë¦¬ê»ë°ê¸° ì„¤íƒ• / ëª¨ë‹ê¸€ë¡œë¦¬ë³¶ìŒ / ì–‘ë°°ì¶”ë³¶ìŒ / ì˜¤ë¦¬ë¼ˆíŠ€ê¹€" },
            { day: 1, stop: 3, name: "ìš°í˜¸ê´‘ì¥ (12:00)", label: "ìš°í˜¸ê´‘ì¥", lat: 38.9238, lng: 121.6366, color: '#007bff', description: "Friendship Square" },
            { day: 1, stop: 4, name: "ëŒ€ë ¨ì—­ íŠ¸ë¨íƒ€ê¸° (12:30)", label: "íŠ¸ë¨", lat: 38.9260, lng: 121.6330, color: '#007bff', description: "201ë²ˆ ì˜¬ë“œ íŠ¸ë¨ ì²´í—˜ (ì¸ë‹¹ 1.5ìœ„ì•ˆ)" },
            { day: 1, stop: 5, name: "ë¯¸ì‰ë¹™ì²­ (13:00)", label: "ë¯¸ì‰ë¹™ì²­", lat: 38.9255, lng: 121.6335, color: '#007bff', isFood: true, description: "ë²„ë¸”í‹°(6ìœ„ì•ˆ), ë””ì €íŠ¸" },
            { day: 1, stop: 6, name: "ë™ë°©ìˆ˜ì„± (13:30)", label: "ë™ë°©ìˆ˜ì„±", lat: 38.9288, lng: 121.6763, color: '#007bff', description: "ëŒ€ë ¨ ë² ë‹ˆìŠ¤ (ê²¨ìš¸ì²  ìš´ì˜ì•ˆí•¨) / ë Œíƒˆìì „ê±° 10ë¶„ 8ìœ„ì•ˆ" },
            { day: 1, stop: 7, name: "ìº‰ì œì–‘ê¼¬ì¹˜ (16:00)", label: "ì–‘ê¼¬ì¹˜", lat: 38.9050, lng: 121.5760, color: '#007bff', isFood: true, description: "ì§€ì‚¼ì„ , ë§Œí† ìš°ê¼¬ì¹˜, ê°€ì§€êµ¬ì´, ë”°ìš”ë¹„ì•¤" },
            { day: 1, stop: 8, name: "êµí†µëŒ€ ì•¼ì‹œì¥ (18:00)", label: "ì•¼ì‹œì¥", lat: 38.9040, lng: 121.5750, color: '#007bff', isFood: true, description: "í­ì¦™ë”°ìš”ë¹„ì•¤(ê³ ê¸°) / ì¥êµ°ê¶ˆì¿ ì´(ë§¤ìš´ë§› ì¶”ì²œ) / ìƒ¤ì˜¤íŒ¡ì°¨ì´í€(ë³¶ìŒë°¥)" },

            // Day 2 (ê¸°ì¡´ Day 1) - ì‡¼í•‘ & ë¨¹ë°©
            { day: 2, stop: 1, name: "ì‹œìŸˆë” ì°ë§Œë‘ (11:00)", label: "ì°ë§Œë‘", lat: 38.9170, lng: 121.6320, color: '#dc3545', isFood: true, description: "ë‚ ì¹˜ì•Œìƒˆìš°ë§Œë‘ (ì¶”(í‘ì‹ì´ˆ)+ë¼ì¡°ì¥+ë§ˆëŠ˜ ë“¬ë¿ ì†ŒìŠ¤ ì¶”ì²œ)" },
            { day: 2, stop: 2, name: "ë£¨ì´ì”½ì»¤í”¼ (12:00)", label: "ì»¤í”¼", lat: 38.9172, lng: 121.6325, color: '#dc3545', isFood: true, description: "Luckin Coffee" },
            { day: 2, stop: 3, name: "íŒŒë¹Œë¦¬ì˜¨ / ë‰´ë§ˆíŠ¸ (12:30)", label: "ì‡¼í•‘ëª°", lat: 38.9168, lng: 121.6322, color: '#dc3545', description: "Pavilion Shopping Mall & New Mart êµ¬ê²½" },
            { day: 2, stop: 4, name: "ë™ê´€ì§€ì— (15:00)", label: "ë™ê´€ì§€ì—", lat: 38.9160, lng: 121.6100, color: '#dc3545', description: "ì—­ì‚¬ ë¬¸í™” ê±°ë¦¬" },
            { day: 2, stop: 5, name: "ë¡œì“°í‘¸ê´‘ì¥ (15:30)", label: "ë¡œì“°í‘¸", lat: 38.9160, lng: 121.5950, color: '#dc3545', description: "Roosevelt Square" },
            { day: 2, stop: 6, name: "ì„œì•ˆë¡œì•¼ì‹œì¥ (16:00)", label: "ì•¼ì‹œì¥", lat: 38.9180, lng: 121.5955, color: '#dc3545', description: "ì‹¤ë‚´ì•¼ì‹œì¥ / ë³´ë³´ì§€, ì§€ìŸˆ, êµ´êµ¬ì´ / ê³µì—° ë³¼ê±°ë¦¬" },
            // Day 2 Dinner Choices
            { day: 2, stop: 7, name: "í›„ë³´: í•˜ì´ë””ë¼ì˜¤", label: "í•˜ì´ë””ë¼ì˜¤", lat: 38.9165, lng: 121.5960, color: '#dc3545', isChoice: true, excludeFromPath: true, description: "í› ê¶ˆ ì „ë¬¸ì  (ë¡œì“°í‘¸ ì¸ê·¼)" },
            { day: 2, stop: 8, name: "í›„ë³´: ë°í› ì¹´ì˜¤ì°¬", label: "ë°í› ", lat: 38.9180, lng: 121.5980, color: '#dc3545', isChoice: true, excludeFromPath: true, description: "êµ¬ì´ ìš”ë¦¬ ì „ë¬¸ì " },
            { day: 2, stop: 9, name: "í›„ë³´: ì²œì¼í•˜", label: "ì²œì¼í•˜", lat: 38.9170, lng: 121.5940, color: '#dc3545', isChoice: true, excludeFromPath: true, description: "ì¼ì‹/í•´ì‚°ë¬¼ ìš”ë¦¬" },

            // Day 3 - ì—­ì‚¬ & ì‹œì¥
            // Day 3 Morning Choices
            { day: 3, stop: 1, name: "í›„ë³´: ì†Œì„±ì£½ë„", label: "ì†Œì„±ì£½ë„", lat: 38.921, lng: 121.645, color: '#28a745', isChoice: true, excludeFromPath: true, description: "ìƒì„¸ì •ë³´: ì„±ê²Œë”¤ì„¬, ì£½" },
            { day: 3, stop: 2, name: "í›„ë³´: ë£¨ì™•ìì´", label: "ë£¨ì™•ìì´", lat: 38.923, lng: 121.641, color: '#28a745', isChoice: true, excludeFromPath: true, description: "ìƒì„¸ì •ë³´: ë”¤ì„¬, íŒŒê¸°ë¦„ë³¶ìŒë©´" },
            
            { day: 3, stop: 3, name: "ëŸ¬ì‹œì•„ê±°ë¦¬ (12:00)", label: "ëŸ¬ì‹œì•„ê±°ë¦¬", lat: 38.9285, lng: 121.6360, color: '#28a745', description: "ì´êµ­ì ì¸ í’ê²½" },
            
            // Day 3 Free Time Choices
            { day: 3, stop: 4, name: "í›„ë³´: ì¹˜ì¹˜ì§€ì—", label: "ì¹˜ì¹˜ì§€ì—", lat: 38.914, lng: 121.655, color: '#28a745', isChoice: true, excludeFromPath: true, description: "ì¹´í˜ ê±°ë¦¬ (Qi Qi Street)" },
            { day: 3, stop: 5, name: "í›„ë³´: ì„±í•´ê´‘ì¥", label: "ì„±í•´ê´‘ì¥", lat: 38.8784, lng: 121.5843, color: '#28a745', isChoice: true, excludeFromPath: true, description: "ëŒ€ë ¨ ëœë“œë§ˆí¬ ê´‘ì¥" },
            { day: 3, stop: 6, name: "í›„ë³´: ë§ˆì‚¬ì§€ìƒµ", label: "ë§ˆì‚¬ì§€", lat: 38.920, lng: 121.630, color: '#28a745', isChoice: true, excludeFromPath: true, description: "ì‹œë‚´ ì¸ê·¼ ë§ˆì‚¬ì§€" },
            { day: 3, stop: 7, name: "í›„ë³´: ì–´ì¸ë¶€ë‘", label: "ì–´ì¸ë¶€ë‘", lat: 38.8755, lng: 121.6781, color: '#28a745', isChoice: true, excludeFromPath: true, description: "í•­êµ¬ í’ê²½ (Fisherman's Wharf)" },

            { day: 3, stop: 8, name: "í‘¸í›„ì´ ì‹ ì„ ì‹í’ˆ (16:00)", label: "ì‹ ì„ ì‹í’ˆ", lat: 38.9200, lng: 121.6400, color: '#28a745', isFood: true, description: "ë§ˆíŠ¸ êµ¬ê²½" },
            { day: 3, stop: 9, name: "ë¼ì˜¤ì§€ì—ì•¼ì‹œì¥ (17:00)", label: "ì•¼ì‹œì¥", lat: 38.9250, lng: 121.6350, color: '#28a745', description: "Old Street Night Market" },
            { day: 3, stop: 10, name: "ë°ì§€ì¹´ì˜¤ìœ„ (19:00)", label: "ì¹´ì˜¤ìœ„", lat: 38.9175, lng: 121.6325, color: '#28a745', isFood: true, description: "ìƒì„ ì°œ(ë†ì–´/ë©”ê¸°, ë§ˆëŠ˜ë§› ì¶”ì²œ), ë””ì—”í•‘ í• ì¸, ìŒ€ë°¥ í•„ìˆ˜" },
            { day: 3, stop: 11, name: "ìˆ™ì†Œ ë„ì°© (22:00)", label: "ìˆ™ì†Œ", lat: 38.9216, lng: 121.6427, color: '#28a745', isAccommodation: true, description: "ì¼ì • ë§ˆë¬´ë¦¬" },

            // Day 4 (ê¸°ì¡´ ìœ ì§€)
            { day: 4, stop: 1, name: "Zhongshan Square (ìˆ™ì†Œ ì¶œë°œ)", label: "ì¶œë°œ", lat: 38.9216, lng: 121.6427, color: '#6f42c1', isAccommodationStart: true },
            { day: 4, stop: 2, name: "Zhoushuizi Int. Airport (DLC) - Departure", label: "ê³µí•­ ì´ë™", lat: 38.966, lng: 121.539, color: '#6f42c1', description: "ëŒ€ë ¨ ì£¼ìˆ˜ì´ì¦ˆ êµ­ì œê³µí•­ìœ¼ë¡œ ì¶œë°œí•©ë‹ˆë‹¤." }
        ];

        var dayLayerGroups = {};
        var foodLayerGroup = L.layerGroup();
        var accommodationMarker;
        var allMarkers = {};

        // ìˆ™ì†Œ ë§ˆì»¤ ìƒì„±
        var accPoint = itinerary.find(p => p.isAccommodation);
        if (accPoint) {
            accommodationMarker = L.marker([accPoint.lat, accPoint.lng], {
                icon: L.divIcon({ className: 'accommodation-icon', html: 'â˜…', iconSize: [32, 32], iconAnchor: [16, 32] }),
                zIndexOffset: 1000
            }).bindPopup(`<div style="text-align: center;"><h3 style="margin:0 0 10px 0; color: #FFC300;">â˜… ìˆ™ì†Œ</h3><b>${accPoint.name}</b><br><small>${accPoint.description || ''}</small></div>`);
        }

        // ë‚ ì§œë³„ ë ˆì´ì–´ ê·¸ë£¹ ìƒì„±
        for (let i = 1; i <= 4; i++) {
            var dayKey = i.toString();
            dayLayerGroups[dayKey] = L.layerGroup();
            var dayPoints = itinerary.filter(p => p.day === i);
            var coordinates = [];
            var color = dayPoints[0] ? dayPoints[0].color : 'gray';

            dayPoints.forEach(function(point) {
                // ê²½ë¡œì— í¬í•¨í• ì§€ ì—¬ë¶€ ì²´í¬
                if (!point.excludeFromPath) {
                    coordinates.push([point.lat, point.lng]);
                }

                var markerIcon;
                var popupContent;

                if (point.isChoice) {
                    markerIcon = L.divIcon({ className: 'custom-div-icon', html: `<div class="choice-marker-label">â“ ${point.label}</div>`, iconAnchor: [0, 0] });
                    popupContent = `<div style="text-align: center; min-width: 200px;"><div style=\"background: linear-gradient(135deg, #e83e8c, #d63384); color: white; padding: 10px; border-radius: 8px 8px 0 0; margin: -10px -10px 10px -10px;\"><h3 style=\"margin: 0; font-size: 1.2em;\">â“ ${point.name}</h3></div><b style=\"color: #e83e8c;\">Day ${point.day} ì„ íƒí›„ë³´</b><br><small style=\"color: #666;\">${point.description || ''}</small></div>`;
                } else if (point.isFood) {
                    markerIcon = L.divIcon({ className: 'custom-div-icon', html: `<div class="food-marker-label">ğŸ´ ${point.label}</div>`, iconAnchor: [0, 0] });
                    popupContent = `<div style="text-align: center; min-width: 200px;"><div style=\"background: linear-gradient(135deg, #ff8c00, #ff6b00); color: white; padding: 10px; border-radius: 8px 8px 0 0; margin: -10px -10px 10px -10px;\"><h3 style=\"margin: 0; font-size: 1.2em;\">ğŸ´ ${point.name}</h3></div><b style=\"color: ${point.color};\">Day ${point.day}</b><br><small style=\"color: #666;\">${point.description || ''}</small></div>`;
                } else if (point.isAirport) {
                    markerIcon = L.divIcon({ className: 'airport-icon', html: 'âœˆï¸', iconSize: [28, 28], iconAnchor: [14, 28] });
                    popupContent = `<div style="text-align: center; min-width: 200px;"><h3 style=\"margin:0 0 10px 0; color: #007bff;\">âœˆï¸ ê³µí•­</h3><b>${point.name}</b><br><small style=\"color:#666;\">${point.description || ''}</small></div>`;
                } else if (point.isAccommodation) {
                    markerIcon = L.divIcon({ className: 'accommodation-icon', html: 'â˜…', iconSize: [32, 32], iconAnchor: [16, 32] });
                    popupContent = `<div style="text-align: center; min-width: 200px;"><h3 style=\"margin:0 0 10px 0; color: #FFC300;\">â˜… ìˆ™ì†Œ</h3><b>${point.name}</b><br><small style=\"color:#666;\">${point.description || ''}</small></div>`;
                } else {
                    markerIcon = L.divIcon({ className: 'custom-div-icon', html: `<div class="marker-label" style="background-color: ${point.color};">${point.label}</div>`, iconAnchor: [0, 0] });
                    popupContent = `<div style="text-align: center; min-width: 200px;"><b style=\"color:${point.color}; font-size:1.1em;\">Day ${point.day}</b><br><h3 style=\"margin:10px 0; font-size:1.2em;\">${point.name}</h3><small style=\"color:#666;\">${point.description || ''}</small></div>`;
                }

                var marker = L.marker([point.lat, point.lng], { icon: markerIcon, zIndexOffset: point.isAccommodation ? 1000 : (point.isAirport ? 900 : 500) }).bindPopup(popupContent);
                dayLayerGroups[dayKey].addLayer(marker);
                allMarkers[`${point.day}-${point.stop}`] = marker;

                if (point.isFood) {
                    foodLayerGroup.addLayer(marker);
                }
            });

            if (coordinates.length > 1) {
                var polyline = L.polyline(coordinates, { color: color, weight: 6, opacity: 0.8, smoothFactor: 1 });
                dayLayerGroups[dayKey].addLayer(polyline);
            }
        }

        // ë‚ ì§œë³„ í•„í„°ë§ í•¨ìˆ˜
        function filterMapByDay(selectedDay) {
            document.getElementById('loading').classList.add('active');
            setTimeout(() => {
                for (let i = 1; i <= 4; i++) {
                    if (map.hasLayer(dayLayerGroups[i.toString()])) map.removeLayer(dayLayerGroups[i.toString()]);
                }
                if (map.hasLayer(foodLayerGroup)) map.removeLayer(foodLayerGroup);
                if (accommodationMarker && map.hasLayer(accommodationMarker)) map.removeLayer(accommodationMarker);

                var visibleCoords = [];
                if (selectedDay === 'all') {
                    for (let i = 1; i <= 4; i++) map.addLayer(dayLayerGroups[i.toString()]);
                    visibleCoords = itinerary.map(p => [p.lat, p.lng]);
                    document.getElementById('dayInfo').classList.add('active');
                    for (let i = 1; i <= 4; i++) document.getElementById(`day${i}Info`).classList.remove('active');
                } else if (dayLayerGroups[selectedDay]) {
                    map.addLayer(dayLayerGroups[selectedDay]);
                    visibleCoords = itinerary.filter(p => p.day.toString() === selectedDay).map(p => [p.lat, p.lng]);
                    document.getElementById('dayInfo').classList.remove('active');
                    for (let i = 1; i <= 4; i++) {
                        if (i.toString() === selectedDay) document.getElementById(`day${i}Info`).classList.add('active');
                        else document.getElementById(`day${i}Info`).classList.remove('active');
                    }
                }

                if (accommodationMarker) {
                    map.addLayer(accommodationMarker);
                    if (!visibleCoords.some(coord => Math.abs(coord[0] - accPoint.lat) < 0.001 && Math.abs(coord[1] - accPoint.lng) < 0.001)) {
                        visibleCoords.push([accPoint.lat, accPoint.lng]);
                    }
                }

                if (visibleCoords.length > 0) {
                    var bounds = L.latLngBounds(visibleCoords);
                    map.fitBounds(bounds, { padding: [80, 80] });
                } else {
                    map.setView([38.915, 121.615], 11);
                }
                document.getElementById('loading').classList.remove('active');
            }, 80);
        }

        function showFoodOnly() {
            document.getElementById('loading').classList.add('active');
            setTimeout(() => {
                for (let i = 1; i <= 4; i++) {
                    if (map.hasLayer(dayLayerGroups[i.toString()])) map.removeLayer(dayLayerGroups[i.toString()]);
                }
                if (accommodationMarker && map.hasLayer(accommodationMarker)) map.removeLayer(accommodationMarker);

                var foodCoords = itinerary.filter(p => p.isFood).map(p => [p.lat, p.lng]);
                map.addLayer(foodLayerGroup);

                document.getElementById('dayInfo').classList.remove('active');
                for (let i = 1; i <= 4; i++) document.getElementById(`day${i}Info`).classList.remove('active');

                if (foodCoords.length > 0) {
                    var bounds = L.latLngBounds(foodCoords);
                    map.fitBounds(bounds, { padding: [80, 80] });
                } else {
                    map.setView([38.915, 121.615], 11);
                }
                document.getElementById('loading').classList.remove('active');
            }, 80);
        }

        function focusMarker(day, stop) {
            var markerKey = `${day}-${stop}`;
            if (allMarkers[markerKey]) {
                map.setView(allMarkers[markerKey].getLatLng(), 15);
                allMarkers[markerKey].openPopup();
            }
        }

        document.getElementById('daySelector').addEventListener('change', function(e) {
            filterMapByDay(e.target.value);
        });
        var legendFood = document.getElementById('legendFood');
        if (legendFood) legendFood.addEventListener('click', showFoodOnly);

        window.addEventListener('load', function() {
            filterMapByDay('all');
            var uniqueStops = new Set();
            itinerary.forEach(p => { if (!p.isAccommodationStart) uniqueStops.add(`${p.lat}-${p.lng}`); });
            document.getElementById('totalStops').textContent = uniqueStops.size;
            fetchWeather();
        });

        map.whenReady(function() {
            document.getElementById('loading').classList.remove('active');
        });
    </script>
</body>
</html>