<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íƒœì›ì›ìƒì˜ ëŒ€ë ¨ ì—¬í–‰ê¸°</title>

    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        .header h1 {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }
        .header p { font-size: 1.1em; opacity: 0.95; }
        .header-info {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 0.9em;
            opacity: 0.9;
            text-align: right;
        }
        .header-weather {
            position: absolute;
            top: 20px;
            left: 30px;
        }
        .weather-info {
            display: inline-flex;
            align-items: center;
            justify-content: space-around;
            flex-direction: row;
            gap: 12px;
            width: 240px;
            height: 120px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            backdrop-filter: blur(10px);
            font-size: 1em;
            vertical-align: middle;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        .weather-icon { font-size: 2.4em; line-height: 1; }
        .weather-text { display: flex; flex-direction: column; align-items: flex-start; gap: 4px; }
        .weather-temp { font-weight: 700; font-size: 1.6em; }
        .weather-desc { font-size: 1.05em; opacity: 0.95; text-align: left; }
        .weather-loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        .weather-alert {
            margin-top: 6px;
            font-size: 0.9em;
            color: #fff;
            background: rgba(0, 0, 0, 0.25);
            padding: 6px 10px;
            border-radius: 12px;
            display: inline-block;
        }
        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 0;
            height: calc(100vh - 200px);
            min-height: 700px;
        }
        .sidebar {
            background: #f8f9fa;
            padding: 25px;
            overflow-y: auto;
            border-right: 1px solid #e0e0e0;
        }
        .control-panel { margin-bottom: 30px; }
        .control-panel h2 {
            font-size: 1.3em;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .day-selector {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #667eea;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 500;
            background: white;
            color: #333;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        .day-selector:hover { border-color: #764ba2; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }
        .day-selector:focus { outline: none; border-color: #764ba2; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2); }
        .legend {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }
        .legend h3 { font-size: 1.1em; margin-bottom: 15px; color: #333; }
        .legend-item { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; padding: 8px; border-radius: 6px; transition: background 0.2s; }
        .legend-item:hover { background: #f0f0f0; }
        .legend-icon { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 4px; font-size: 14px; }
        .legend-clickable { cursor: pointer; user-select: none; }
        .info-panel { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }
        .info-panel h3 { font-size: 1.1em; margin-bottom: 15px; color: #333; }
        .day-info { display: none; animation: fadeIn 0.3s ease; }
        .day-info.active { display: block; }
        .day-info h4 { color: #667eea; margin-bottom: 10px; font-size: 1.2em; }
        .stop-item { padding: 10px; margin-bottom: 8px; background: #f8f9fa; border-left: 4px solid #667eea; border-radius: 4px; cursor: pointer; transition: all 0.2s; }
        .stop-item:hover { background: #e9ecef; transform: translateX(5px); }
        .stop-item.food { border-left-color: #ff8c00; }
        .stop-item.accommodation { border-left-color: #FFC300; }
        .map-container { position: relative; background: #e0e0e0; }
        #map { width: 100%; height: 100%; }
        .custom-div-icon { background-color: transparent; border: none; text-align: center; }
        .marker-label {
            color: white; padding: 6px 10px; border-radius: 8px; font-weight: 600; font-size: 13px;
            white-space: nowrap; border: 2px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            position: absolute; transform: translate(-50%, -100%); margin-top: -5px; font-family: 'Noto Sans KR', sans-serif;
        }
        .food-marker-label {
            background: linear-gradient(135deg, #ff8c00, #ff6b00); color: white; padding: 6px 10px; border-radius: 8px;
            font-weight: 600; font-size: 13px; white-space: nowrap; border: 2px solid white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); position: absolute; transform: translate(-50%, -100%);
            margin-top: -5px; font-family: 'Noto Sans KR', sans-serif;
        }
        .accommodation-icon { background-color: transparent; border: none; text-align: center; font-size: 32px; line-height: 1; color: #FFC300; text-shadow: 0 0 10px rgba(0, 0, 0, 0.8), 0 0 20px rgba(255, 195, 0, 0.5); filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3)); }
        .airport-icon { background-color: transparent; border: none; text-align: center; font-size: 28px; line-height: 1; color: #007bff; text-shadow: 0 0 10px rgba(0, 0, 0, 0.8); filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3)); }
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .stat-item { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 12px; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 1.5em; font-weight: 700; }
        .stat-label { font-size: 0.9em; opacity: 0.9; }
        .loading { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; background: white; padding: 20px 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2); }
        .loading.active { display: block; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px);} to { opacity: 1; transform: translateY(0);} }
        @media (max-width: 1024px) {
            .main-content { grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
            .sidebar { max-height: 320px; border-right: none; border-bottom: 1px solid #e0e0e0; }
            .header h1 { font-size: 2em; }
            .header-info { position: static; margin-top: 10px; text-align: center; }
            .header-weather { position: static; margin: 10px 0; text-align: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-weather">
                <span id="weatherInfo" class="weather-info"><span class="weather-loading"></span></span>
                <div id="weatherAlert" class="weather-alert" style="display:none;"></div>
            </div>
            <div class="header-info">
                ì‘ì„±ì: ì •ì›ì² <br>
                ì‘ì„±ì¼: 2025ë…„ 12ì›” 9ì¼
            </div>
            <h1><i class="fas fa-map-marked-alt"></i> íƒœì›ì›ìƒì˜ ëŒ€ë ¨ ì—¬í–‰ê¸°</h1>
            <p>2025.01.23(ê¸ˆ) ~ 01.26(ì›”)</p>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="control-panel">
                    <h2><i class="fas fa-calendar-alt"></i> ë™ì„  ì„ íƒ</h2>
                    <select id="daySelector" class="day-selector">
                        <option value="all">ğŸ“… ì „ì²´ ë³´ê¸° (Day 1-4)</option>
                        <option value="1">Day 1 - ë„ì‹¬ íƒë°©</option>
                        <option value="2">Day 2 - í•´ì•ˆ ê´€ê´‘</option>
                        <option value="3">Day 3 - ì‡¼í•‘ & ì¹´í˜</option>
                        <option value="4">Day 4 - ì¶œë°œ</option>
                    </select>
                </div>

                <div class="info-panel">
                    <h3><i class="fas fa-list"></i> ìƒì„¸ ì •ë³´</h3>
                    <div id="dayInfo" class="day-info active">
                        <h4>ì „ì²´ ì—¬í–‰ ì¼ì •</h4>
                        <p style="color: #666; margin-bottom: 15px;">4ì¼ê°„ì˜ ëŒ€ë ¨ ì—¬í–‰ ì½”ìŠ¤ë¥¼ í™•ì¸í•˜ì„¸ìš”. ê° ë‚ ì§œë¥¼ ì„ íƒí•˜ë©´ í•´ë‹¹ ì¼ì •ì˜ ìƒì„¸ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
                        <div class="stats">
                            <div class="stat-item">
                                <div class="stat-value">4</div>
                                <div class="stat-label">ì—¬í–‰ ì¼ìˆ˜</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="totalStops">12</div>
                                <div class="stat-label">ì´ ë°©ë¬¸ì§€</div>
                            </div>
                        </div>
                    </div>
                    <div id="day1Info" class="day-info">
                        <h4>Day 1 - ë„ì‹¬ íƒë°©</h4>
                        <div class="stop-item" onclick="focusMarker(1, 1)">
                            <strong>1. ì£¼ìˆ˜ì´ì¦ˆ êµ­ì œê³µí•­ (DLC) ë„ì°©</strong><br>
                            <small>âœˆï¸ ê³µí•­ ë„ì°©</small>
                        </div>
                        <div class="stop-item accommodation" onclick="focusMarker(1, 2)">
                            <strong>2. ì¤‘ì‚°ê´‘ì¥ (ìˆ™ì†Œ)</strong><br>
                            <small>ì—¬í–‰ ê¸°ê°„ ìˆ™ì†Œ</small>
                        </div>
                        <div class="stop-item" onclick="focusMarker(1, 3)">
                            <strong>3. ëŸ¬ì‹œì•„ ê±°ë¦¬</strong><br>
                            <small>ëŸ¬ì‹œì•„ ê±´ì¶•ë¬¼ê³¼ ë¬¸í™” ì²´í—˜</small>
                        </div>
                        <div class="stop-item" onclick="focusMarker(1, 4)">
                            <strong>4. ë² ë‹ˆìŠ¤ ë¬¼ì˜ ë„ì‹œ</strong><br>
                            <small>ìœ ëŸ½í’ ìˆ˜ìƒ ë„ì‹œ í…Œë§ˆíŒŒí¬</small>
                        </div>
                    </div>
                    <div id="day2Info" class="day-info">
                        <h4>Day 2 - í•´ì•ˆ ê´€ê´‘</h4>
                        <div class="stop-item" onclick="focusMarker(2, 1)">
                            <strong>1. ì¤‘ì‚°ê´‘ì¥ ì¶œë°œ</strong>
                        </div>
                        <div class="stop-item" onclick="focusMarker(2, 2)">
                            <strong>2. ë¼ì˜¤í›„íƒ„ í•´ì–‘ ê³µì›</strong><br>
                            <small>í•´ì–‘ ë™ë¬¼ ì‡¼ì™€ í…Œë§ˆíŒŒí¬</small>
                        </div>
                        <div class="stop-item" onclick="focusMarker(2, 3)">
                            <strong>3. ì–´ì¸ ë¶€ë‘</strong><br>
                            <small>ì „í†µ ì–´ì´Œ ë§ˆì„</small>
                        </div>
                        <div class="stop-item food" onclick="focusMarker(2, 4)">
                            <strong>4. ë§Œë³´í•´ì„ ë°© ğŸ´</strong><br>
                            <small>ì‹ ì„ í•œ í•´ì‚°ë¬¼ ë§›ì§‘</small>
                        </div>
                        <div class="stop-item" onclick="focusMarker(2, 5)">
                            <strong>5. ì„±í•´ ê´‘ì¥</strong><br>
                            <small>ëŒ€ë ¨ì˜ ëŒ€í‘œ ê´‘ì¥</small>
                        </div>
                    </div>
                    <div id="day3Info" class="day-info">
                        <h4>Day 3 - ì‡¼í•‘ & ì¹´í˜</h4>
                        <div class="stop-item" onclick="focusMarker(3, 1)">
                            <strong>1. ì¤‘ì‚°ê´‘ì¥ ì¶œë°œ</strong>
                        </div>
                        <div class="stop-item" onclick="focusMarker(3, 2)">
                            <strong>2. 15ê³  ì¹´í˜ê±°ë¦¬</strong><br>
                            <small>íŠ¸ë Œë””í•œ ì¹´í˜ ê±°ë¦¬</small>
                        </div>
                        <div class="stop-item" onclick="focusMarker(3, 3)">
                            <strong>3. íŒŒë¹Œë¦¬ì˜¨ ì‡¼í•‘</strong><br>
                            <small>ì‡¼í•‘ëª°</small>
                        </div>
                        <div class="stop-item" onclick="focusMarker(3, 4)">
                            <strong>4. ì¹­ë‹ˆì™€ì± ì˜¤ ì‡¼í•‘</strong><br>
                            <small>ëŒ€ë ¨ ìµœëŒ€ ì‡¼í•‘ëª°</small>
                        </div>
                    </div>
                    <div id="day4Info" class="day-info">
                        <h4>Day 4 - ì¶œë°œ</h4>
                        <div class="stop-item" onclick="focusMarker(4, 1)">
                            <strong>1. ì¤‘ì‚°ê´‘ì¥ ì¶œë°œ</strong>
                        </div>
                        <div class="stop-item" onclick="focusMarker(4, 2)">
                            <strong>2. ì£¼ìˆ˜ì´ì¦ˆ êµ­ì œê³µí•­ (DLC)</strong><br>
                            <small>ì¶œë°œ</small>
                        </div>
                    </div>
                </div>

                <div class="legend">
                    <h3><i class="fas fa-info-circle"></i> ë²”ë¡€</h3>
                    <div class="legend-item">
                        <div class="legend-icon" style="background: #FFC300; color: white;"><i class="fas fa-star"></i></div>
                        <span>ìˆ™ì†Œ (ì¤‘ì‚°ê´‘ì¥)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-icon" style="background: #007bff; color: white;"><i class="fas fa-plane"></i></div>
                        <span>ê³µí•­</span>
                    </div>
                    <div class="legend-item legend-clickable" id="legendFood">
                        <div class="legend-icon" style="background: #ff8c00; color: white;"><i class="fas fa-utensils"></i></div>
                        <span>ìŒì‹ì </span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-icon" style="background: #007bff; color: white;"><i class="fas fa-map-marker-alt"></i></div>
                        <span>Day 1 ê²½ë¡œ</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-icon" style="background: #dc3545; color: white;"><i class="fas fa-map-marker-alt"></i></div>
                        <span>Day 2 ê²½ë¡œ</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-icon" style="background: #28a745; color: white;"><i class="fas fa-map-marker-alt"></i></div>
                        <span>Day 3 ê²½ë¡œ</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-icon" style="background: #6f42c1; color: white;"><i class="fas fa-map-marker-alt"></i></div>
                        <span>Day 4 ê²½ë¡œ</span>
                    </div>
                </div>
            </div>

            <div class="map-container">
                <div id="map"></div>
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <div>ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // OpenWeatherMap API í‚¤ (ì‚¬ìš©ì ì œê³µ í‚¤)
        const WEATHER_API_KEY = '9a9542cafe537472257fc12fa6f9d2d5';
        const DALIAN_LAT = 38.915;
        const DALIAN_LNG = 121.615;

        async function fetchWeather() {
            try {
                const url = `https://api.openweathermap.org/data/2.5/weather?lat=${DALIAN_LAT}&lon=${DALIAN_LNG}&appid=${WEATHER_API_KEY}&units=metric&lang=kr`;
                const response = await fetch(url);
                if (!response.ok) throw new Error('ë‚ ì”¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                const data = await response.json();
                displayWeather(data);
            } catch (error) {
                console.error('ë‚ ì”¨ ì •ë³´ ì˜¤ë¥˜:', error);
                document.getElementById('weatherInfo').innerHTML = '<span style="font-size: 0.8em; opacity: 0.8;">ë‚ ì”¨ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</span>';
            }
        }

        function displayWeather(data) {
            const temp = Math.round(data.main.temp);
            const description = data.weather[0].description;
            const main = data.weather[0].main.toLowerCase();
            const icon = data.weather[0].icon;
            const iconUrl = `https://openweathermap.org/img/wn/${icon}@2x.png`;
            const iconSymbolMap = {
                thunderstorm: 'â›ˆï¸',
                drizzle: 'ğŸŒ¦ï¸',
                rain: 'ğŸŒ§ï¸',
                snow: 'ğŸŒ¨ï¸',
                clear: 'â˜€ï¸',
                clouds: 'â˜ï¸',
                mist: 'ğŸŒ«ï¸',
                haze: 'ğŸŒ«ï¸',
                fog: 'ğŸŒ«ï¸'
            };
            const iconSymbol = iconSymbolMap[main] || 'ğŸŒ¤ï¸';
            const weatherHTML = `
                <span class="weather-icon">${iconSymbol}</span>
                <div class="weather-text">
                    <span class="weather-temp">${temp}Â°C</span>
                    <span class="weather-desc">${description}</span>
                </div>
            `;
            document.getElementById('weatherInfo').innerHTML = weatherHTML;

            // ë¹„/ëˆˆ ì•Œë¦¼
            const alertBox = document.getElementById('weatherAlert');
            const isRain = ['rain', 'drizzle', 'thunderstorm'].includes(main) || description.includes('ë¹„');
            const isSnow = ['snow'].includes(main) || description.includes('ëˆˆ');
            if (isRain) {
                alertBox.textContent = 'ë¹„ ì˜ˆë³´: ìš°ì‚°ì„ ì¤€ë¹„í•˜ì„¸ìš”!';
                alertBox.style.display = 'inline-block';
            } else if (isSnow) {
                alertBox.textContent = 'ëˆˆ ì˜ˆë³´: ë”°ëœ»í•œ ë³µì¥ê³¼ ë¯¸ë„ëŸ¼ ì£¼ì˜!';
                alertBox.style.display = 'inline-block';
            } else {
                alertBox.style.display = 'none';
            }
        }

        // ì§€ë„ ì´ˆê¸°í™”
        var map = L.map('map', { zoomControl: true, scrollWheelZoom: true }).setView([38.915, 121.615], 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // ì—¬í–‰ ì¼ì • ë°ì´í„°
        var itinerary = [
            // Day 1
            { day: 1, stop: 1, name: "Zhoushuizi Int. Airport (DLC) - Arrival", label: "ê³µí•­ ë„ì°©", lat: 38.966, lng: 121.539, color: '#007bff', isAirport: true, description: "ëŒ€ë ¨ ì£¼ìˆ˜ì´ì¦ˆ êµ­ì œê³µí•­ ë„ì°©ì…ë‹ˆë‹¤." },
            { day: 1, stop: 2, name: "Zhongshan Square (ì—¬í–‰ ê¸°ê°„ ìˆ™ì†Œ)", label: "ìˆ™ì†Œ", lat: 38.9216, lng: 121.6427, color: '#007bff', isAccommodation: true, description: "ì—¬í–‰ ê¸°ê°„ ë™ì•ˆ ë¨¸ë¬´ë¥¼ ìˆ™ì†Œì…ë‹ˆë‹¤." },
            { day: 1, stop: 3, name: "Russian Street (ëŸ¬ì‹œì•„ ê±°ë¦¬)", label: "ëŸ¬ì‹œì•„ ê±°ë¦¬", lat: 38.9285, lng: 121.636, color: '#007bff', description: "ëŸ¬ì‹œì•„ ê±´ì¶•ë¬¼ê³¼ ë¬¸í™”ë¥¼ ì²´í—˜í•  ìˆ˜ ìˆëŠ” ê±°ë¦¬ì…ë‹ˆë‹¤." },
            { day: 1, stop: 4, name: "Venice Water City (ë² ë‹ˆìŠ¤ ë¬¼ì˜ ë„ì‹œ)", label: "ë² ë‹ˆìŠ¤ ë¬¼ì˜ë„ì‹œ", lat: 38.9288, lng: 121.6763, color: '#007bff', description: "ìœ ëŸ½í’ ìˆ˜ìƒ ë„ì‹œ í…Œë§ˆíŒŒí¬ì…ë‹ˆë‹¤." },

            // Day 2
            { day: 2, stop: 1, name: "Zhongshan Square (ìˆ™ì†Œ ì¶œë°œ)", label: "ì¶œë°œ", lat: 38.9216, lng: 121.6427, color: '#dc3545', isAccommodationStart: true },
            { day: 2, stop: 2, name: "Laohutan Ocean Park (ë¼ì˜¤í›„íƒ„ í•´ì–‘ ê³µì›)", label: "ë¼ì˜¤í›„íƒ„", lat: 38.8748, lng: 121.6731, color: '#dc3545', description: "í•´ì–‘ ë™ë¬¼ ì‡¼ì™€ ë‹¤ì–‘í•œ í…Œë§ˆíŒŒí¬ ì‹œì„¤ì´ ìˆëŠ” ê³µì›ì…ë‹ˆë‹¤." },
            { day: 2, stop: 3, name: "Fisherman's Wharf (ì–´ì¸ ë¶€ë‘)", label: "ì–´ì¸ë¶€ë‘", lat: 38.8755, lng: 121.6781, color: '#dc3545', description: "ì „í†µ ì–´ì´Œ ë§ˆì„ì˜ ë¶„ìœ„ê¸°ë¥¼ ëŠë‚„ ìˆ˜ ìˆëŠ” ë¶€ë‘ì…ë‹ˆë‹¤." },
            { day: 2, stop: 4, name: "Wanbao Seafood Fang (ë§Œë³´í•´ì„ ë°© - í•´ì‚°ë¬¼ ë§›ì§‘)", label: "ë§Œë³´í•´ì„ ë°©", lat: 38.895, lng: 121.6961, color: '#dc3545', isFood: true, description: "ì‹ ì„ í•œ í•´ì‚°ë¬¼ì„ ë§›ë³¼ ìˆ˜ ìˆëŠ” ìœ ëª… ë§›ì§‘ì…ë‹ˆë‹¤." },
            { day: 2, stop: 5, name: "Xinghai Square (ì„±í•´ ê´‘ì¥)", label: "ì„±í•´ê´‘ì¥", lat: 38.8784, lng: 121.5843, color: '#dc3545', description: "ëŒ€ë ¨ì˜ ëŒ€í‘œì ì¸ ê´‘ì¥ìœ¼ë¡œ ì•„ë¦„ë‹¤ìš´ í•´ì•ˆ ê²½ê´€ì„ ê°ìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤." },

            // Day 3
            { day: 3, stop: 1, name: "Zhongshan Square (ìˆ™ì†Œ ì¶œë°œ)", label: "ì¶œë°œ", lat: 38.9216, lng: 121.6427, color: '#28a745', isAccommodationStart: true },
            { day: 3, stop: 2, name: "15th Street Cafe Area (15ê³  ì¹´í˜ê±°ë¦¬)", label: "15ê³  ì¹´í˜", lat: 38.929, lng: 121.662, color: '#28a745', description: "íŠ¸ë Œë””í•œ ì¹´í˜ë“¤ì´ ëª¨ì—¬ìˆëŠ” ê±°ë¦¬ì…ë‹ˆë‹¤." },
            { day: 3, stop: 3, name: "Pavilion Shopping (íŒŒë¹Œë¦¬ì˜¨ ì‡¼í•‘)", label: "íŒŒë¹Œë¦¬ì˜¨", lat: 38.9170, lng: 121.6320, color: '#28a745', description: "ë‹¤ì–‘í•œ ì‡¼í•‘ ì‹œì„¤ì´ ìˆëŠ” ì‡¼í•‘ëª°ì…ë‹ˆë‹¤." },
            { day: 3, stop: 4, name: "Qingniwaqiao (ì¹­ë‹ˆì™€ì± ì˜¤ ì‡¼í•‘)", label: "ì¹­ë‹ˆì™€", lat: 38.916, lng: 121.621, color: '#28a745', description: "ëŒ€ë ¨ ìµœëŒ€ ê·œëª¨ì˜ ì‡¼í•‘ëª°ì…ë‹ˆë‹¤." },

            // Day 4
            { day: 4, stop: 1, name: "Zhongshan Square (ìˆ™ì†Œ ì¶œë°œ)", label: "ì¶œë°œ", lat: 38.9216, lng: 121.6427, color: '#6f42c1', isAccommodationStart: true },
            { day: 4, stop: 2, name: "Zhoushuizi Int. Airport (DLC) - Departure", label: "ê³µí•­ ì´ë™", lat: 38.966, lng: 121.539, color: '#6f42c1', description: "ëŒ€ë ¨ ì£¼ìˆ˜ì´ì¦ˆ êµ­ì œê³µí•­ìœ¼ë¡œ ì¶œë°œí•©ë‹ˆë‹¤." }
        ];

        var dayLayerGroups = {};
        var foodLayerGroup = L.layerGroup();
        var accommodationMarker;
        var allMarkers = {};

        // ìˆ™ì†Œ ë§ˆì»¤ ìƒì„±
        var accPoint = itinerary.find(p => p.isAccommodation);
        if (accPoint) {
            accommodationMarker = L.marker([accPoint.lat, accPoint.lng], {
                icon: L.divIcon({ className: 'accommodation-icon', html: 'â˜…', iconSize: [32, 32], iconAnchor: [16, 32] }),
                zIndexOffset: 1000
            }).bindPopup(`<div style="text-align: center;"><h3 style="margin:0 0 10px 0; color: #FFC300;">â˜… ìˆ™ì†Œ</h3><b>${accPoint.name}</b><br><small>${accPoint.description || ''}</small></div>`);
        }

        // ë‚ ì§œë³„ ë ˆì´ì–´ ê·¸ë£¹ ìƒì„±
        for (let i = 1; i <= 4; i++) {
            var dayKey = i.toString();
            dayLayerGroups[dayKey] = L.layerGroup();
            var dayPoints = itinerary.filter(p => p.day === i);
            var coordinates = [];
            var color = dayPoints[0] ? dayPoints[0].color : 'gray';

            dayPoints.forEach(function(point) {
                // ëª¨ë“  ì§€ì ì„ ê²½ë¡œì— í¬í•¨ (ì¶œë°œì ë„ í¬í•¨)
                coordinates.push([point.lat, point.lng]);

                var markerIcon;
                var popupContent;

                if (point.isFood) {
                    markerIcon = L.divIcon({ className: 'custom-div-icon', html: `<div class="food-marker-label">ğŸ´ ${point.label}</div>`, iconAnchor: [0, 0] });
                    popupContent = `<div style="text-align: center; min-width: 200px;"><div style=\"background: linear-gradient(135deg, #ff8c00, #ff6b00); color: white; padding: 10px; border-radius: 8px 8px 0 0; margin: -10px -10px 10px -10px;\"><h3 style=\"margin: 0; font-size: 1.2em;\">ğŸ´ ${point.name}</h3></div><b style=\"color: ${point.color};\">Day ${point.day}</b><br><small style=\"color: #666;\">${point.description || ''}</small></div>`;
                } else if (point.isAirport) {
                    markerIcon = L.divIcon({ className: 'airport-icon', html: 'âœˆï¸', iconSize: [28, 28], iconAnchor: [14, 28] });
                    popupContent = `<div style="text-align: center; min-width: 200px;"><h3 style=\"margin:0 0 10px 0; color: #007bff;\">âœˆï¸ ê³µí•­</h3><b>${point.name}</b><br><small style=\"color:#666;\">${point.description || ''}</small></div>`;
                } else if (point.isAccommodation) {
                    markerIcon = L.divIcon({ className: 'accommodation-icon', html: 'â˜…', iconSize: [32, 32], iconAnchor: [16, 32] });
                    popupContent = `<div style="text-align: center; min-width: 200px;"><h3 style=\"margin:0 0 10px 0; color: #FFC300;\">â˜… ìˆ™ì†Œ</h3><b>${point.name}</b><br><small style=\"color:#666;\">${point.description || ''}</small></div>`;
                } else {
                    markerIcon = L.divIcon({ className: 'custom-div-icon', html: `<div class="marker-label" style="background-color: ${point.color};">${point.label}</div>`, iconAnchor: [0, 0] });
                    popupContent = `<div style="text-align: center; min-width: 200px;"><b style=\"color:${point.color}; font-size:1.1em;\">Day ${point.day}</b><br><h3 style=\"margin:10px 0; font-size:1.2em;\">${point.name}</h3><small style=\"color:#666;\">${point.description || ''}</small></div>`;
                }

                var marker = L.marker([point.lat, point.lng], { icon: markerIcon, zIndexOffset: point.isAccommodation ? 1000 : (point.isAirport ? 900 : 500) }).bindPopup(popupContent);
                dayLayerGroups[dayKey].addLayer(marker);
                allMarkers[`${point.day}-${point.stop}`] = marker;

                // ìŒì‹ì  ì „ìš© ë ˆì´ì–´ì—ë„ ì¶”ê°€
                if (point.isFood) {
                    foodLayerGroup.addLayer(marker);
                }
            });

            if (coordinates.length > 1) {
                var polyline = L.polyline(coordinates, { color: color, weight: 6, opacity: 0.8, smoothFactor: 1 });
                dayLayerGroups[dayKey].addLayer(polyline);
            }
        }

        // ë‚ ì§œë³„ í•„í„°ë§ í•¨ìˆ˜
        function filterMapByDay(selectedDay) {
            document.getElementById('loading').classList.add('active');
            setTimeout(() => {
                for (let i = 1; i <= 4; i++) {
                    if (map.hasLayer(dayLayerGroups[i.toString()])) map.removeLayer(dayLayerGroups[i.toString()]);
                }
                if (map.hasLayer(foodLayerGroup)) map.removeLayer(foodLayerGroup);
                if (accommodationMarker && map.hasLayer(accommodationMarker)) map.removeLayer(accommodationMarker);

                var visibleCoords = [];
                if (selectedDay === 'all') {
                    for (let i = 1; i <= 4; i++) map.addLayer(dayLayerGroups[i.toString()]);
                    visibleCoords = itinerary.map(p => [p.lat, p.lng]);
                    document.getElementById('dayInfo').classList.add('active');
                    for (let i = 1; i <= 4; i++) document.getElementById(`day${i}Info`).classList.remove('active');
                } else if (dayLayerGroups[selectedDay]) {
                    map.addLayer(dayLayerGroups[selectedDay]);
                    visibleCoords = itinerary.filter(p => p.day.toString() === selectedDay).map(p => [p.lat, p.lng]);
                    document.getElementById('dayInfo').classList.remove('active');
                    for (let i = 1; i <= 4; i++) {
                        if (i.toString() === selectedDay) document.getElementById(`day${i}Info`).classList.add('active');
                        else document.getElementById(`day${i}Info`).classList.remove('active');
                    }
                }

                if (accommodationMarker) {
                    map.addLayer(accommodationMarker);
                    if (!visibleCoords.some(coord => Math.abs(coord[0] - accPoint.lat) < 0.001 && Math.abs(coord[1] - accPoint.lng) < 0.001)) {
                        visibleCoords.push([accPoint.lat, accPoint.lng]);
                    }
                }

                if (visibleCoords.length > 0) {
                    var bounds = L.latLngBounds(visibleCoords);
                    map.fitBounds(bounds, { padding: [80, 80] });
                } else {
                    map.setView([38.915, 121.615], 11);
                }
                document.getElementById('loading').classList.remove('active');
            }, 80);
        }

        // ìŒì‹ì ë§Œ ë³´ê¸° (ë™ì„  ì—†ì´)
        function showFoodOnly() {
            document.getElementById('loading').classList.add('active');
            setTimeout(() => {
                for (let i = 1; i <= 4; i++) {
                    if (map.hasLayer(dayLayerGroups[i.toString()])) map.removeLayer(dayLayerGroups[i.toString()]);
                }
                if (accommodationMarker && map.hasLayer(accommodationMarker)) map.removeLayer(accommodationMarker);

                var foodCoords = itinerary.filter(p => p.isFood).map(p => [p.lat, p.lng]);
                map.addLayer(foodLayerGroup);

                // ì •ë³´ íŒ¨ë„ ë¹„í™œì„±í™” (ë‚ ì§œ ì •ë³´ ìˆ¨ê¹€)
                document.getElementById('dayInfo').classList.remove('active');
                for (let i = 1; i <= 4; i++) document.getElementById(`day${i}Info`).classList.remove('active');

                if (foodCoords.length > 0) {
                    var bounds = L.latLngBounds(foodCoords);
                    map.fitBounds(bounds, { padding: [80, 80] });
                } else {
                    map.setView([38.915, 121.615], 11);
                }
                document.getElementById('loading').classList.remove('active');
            }, 80);
        }

        function focusMarker(day, stop) {
            var markerKey = `${day}-${stop}`;
            if (allMarkers[markerKey]) {
                map.setView(allMarkers[markerKey].getLatLng(), 15);
                allMarkers[markerKey].openPopup();
            }
        }

        document.getElementById('daySelector').addEventListener('change', function(e) {
            filterMapByDay(e.target.value);
        });
        var legendFood = document.getElementById('legendFood');
        if (legendFood) legendFood.addEventListener('click', showFoodOnly);

        window.addEventListener('load', function() {
            filterMapByDay('all');
            var uniqueStops = new Set();
            itinerary.forEach(p => { if (!p.isAccommodationStart) uniqueStops.add(`${p.lat}-${p.lng}`); });
            document.getElementById('totalStops').textContent = uniqueStops.size;
            fetchWeather();
        });

        map.whenReady(function() {
            document.getElementById('loading').classList.remove('active');
        });
    </script>
</body>
</html>
